<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
      crossorigin="anonymous"
    />

    <title>LED Feather Wing</title>
  </head>
  <body class="bg-light">
    <div class="container" style="max-width: 960px">
      <main>
        <div class="py-5 text-center">
          <h2>LED Feather Wing</h2>
          <p class="lead">TKTK</p>
        </div>

        <div class="row g-3">
          <div class="col-md-7 col-lg-12">
            <h4 class="mb-3">Device Settings</h4>
            <form class="needs-validation" novalidate>
              <div class="row g-3">
                <div class="col-12">
                  <label for="mDeviceName" class="form-label"
                    >Device Name</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="mDdeviceName"
                    name="mDeviceName"
                    placeholder="Device Name"
                  />
                </div>

                <div class="col-12">
                  <label for="mTimezoneOffsetMinutes" class="form-label"
                    >Time Zone</label
                  >
                  <select
                    name="mTimezoneOffsetMinutes"
                    id="mTimezoneOffsetMinutes"
                    class="form-control"
                  >
                    <option value="-720">
                      (GMT -12:00) Eniwetok, Kwajalein
                    </option>
                    <option value="-660">
                      (GMT -11:00) Midway Island, Samoa
                    </option>
                    <option value="-600">(GMT -10:00) Hawaii</option>
                    <option value="-590">(GMT -9:30) Taiohae</option>
                    <option value="-540">(GMT -9:00) Alaska</option>
                    <option value="-480">
                      (GMT -8:00) Pacific Time (US &amp; Canada)
                    </option>
                    <option value="-420">
                      (GMT -7:00) Mountain Time (US &amp; Canada)
                    </option>
                    <option value="-360">
                      (GMT -6:00) Central Time (US &amp; Canada), Mexico City
                    </option>
                    <option value="-300">
                      (GMT -5:00) Eastern Time (US &amp; Canada), Bogota, Lima
                    </option>
                    <option value="-290">(GMT -4:30) Caracas</option>
                    <option value="-240">
                      (GMT -4:00) Atlantic Time (Canada), Caracas, La Paz
                    </option>
                    <option value="-230">(GMT -3:30) Newfoundland</option>
                    <option value="-180">
                      (GMT -3:00) Brazil, Buenos Aires, Georgetown
                    </option>
                    <option value="-120">(GMT -2:00) Mid-Atlantic</option>
                    <option value="-60">
                      (GMT -1:00) Azores, Cape Verde Islands
                    </option>
                    <option value="0">
                      (GMT) Western Europe Time, London, Lisbon, Casablanca
                    </option>
                    <option value="60">
                      (GMT +1:00) Brussels, Copenhagen, Madrid, Paris
                    </option>
                    <option value="120">
                      (GMT +2:00) Kaliningrad, South Africa
                    </option>
                    <option value="180">
                      (GMT +3:00) Baghdad, Riyadh, Moscow, St. Petersburg
                    </option>
                    <option value="230">(GMT +3:30) Tehran</option>
                    <option value="240">
                      (GMT +4:00) Abu Dhabi, Muscat, Baku, Tbilisi
                    </option>
                    <option value="290">(GMT +4:30) Kabul</option>
                    <option value="300">
                      (GMT +5:00) Ekaterinburg, Islamabad, Karachi, Tashkent
                    </option>
                    <option value="350">
                      (GMT +5:30) Bombay, Calcutta, Madras, New Delhi
                    </option>
                    <option value="375">(GMT +5:45) Kathmandu, Pokhara</option>
                    <option value="360">
                      (GMT +6:00) Almaty, Dhaka, Colombo
                    </option>
                    <option value="410">(GMT +6:30) Yangon, Mandalay</option>
                    <option value="420">
                      (GMT +7:00) Bangkok, Hanoi, Jakarta
                    </option>
                    <option value="480">
                      (GMT +8:00) Beijing, Perth, Singapore, Hong Kong
                    </option>
                    <option value="555">(GMT +8:45) Eucla</option>
                    <option value="540">
                      (GMT +9:00) Tokyo, Seoul, Osaka, Sapporo, Yakutsk
                    </option>
                    <option value="590">(GMT +9:30) Adelaide, Darwin</option>
                    <option value="600">
                      (GMT +10:00) Eastern Australia, Guam, Vladivostok
                    </option>
                    <option value="650">(GMT +10:30) Lord Howe Island</option>
                    <option value="660">
                      (GMT +11:00) Magadan, Solomon Islands, New Caledonia
                    </option>
                    <option value="710">(GMT +11:30) Norfolk Island</option>
                    <option value="720">
                      (GMT +12:00) Auckland, Wellington, Fiji, Kamchatka
                    </option>
                    <option value="795">(GMT +12:45) Chatham Islands</option>
                    <option value="780">(GMT +13:00) Apia, Nukualofa</option>
                    <option value="840">
                      (GMT +14:00) Line Islands, Tokelau
                    </option>
                  </select>
                </div>

                <div class="form-check">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    id="mUseDst"
                    name="mUseDst"
                  />
                  <label class="form-check-label" for="mUseDst"
                    >Use Daylight Saving Time</label
                  >
                </div>

                <div class="form-check">
                  <label for="mBrightness" class="form-label">Brightness</label>
                  <input
                    type="range"
                    class="form-range"
                    min="0"
                    max="255"
                    id="mBrightness"
                    name="mBrightness"
                    value="255"
                  />
                </div>

                <div class="col-sm-3">
                  <label for="mAnimationIndex" class="form-label"
                    >Animation Index</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="mAnimationIndex"
                    name="mAnimationIndex"
                  />
                </div>

                <hr class="my-4" />

                <div class="row">
                  <div class="col-sm-3">
                    <p class="lead">Strip A</p>
                    <div class="form-check">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="enableStrip1"
                        name="enableStrip1"
                      />
                      <label class="form-check-label" for="enableStrip1"
                        >Enable</label
                      >
                    </div>

                    <div class="form-check">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="invertStrip1"
                        name="invertStrip1"
                      />
                      <label class="form-check-label" for="invertStrip1"
                        >Invert</label
                      >
                    </div>
                    <div>
                      <label for="indexStrip1" class="form-label"
                        >Display Index</label
                      >
                      <input
                        type="number"
                        min="0"
                        max="16"
                        class="form-control"
                        id="indexStrip1"
                        name="indexStrip1"
                      />
                    </div>
                    <div>
                      <label for="lengthStrip1" class="form-label"
                        >LED Count</label
                      >
                      <input
                        type="number"
                        min="0"
                        max="150"
                        class="form-control"
                        id="lengthStrip1"
                        name="lengthStrip1"
                      />
                    </div>
                  </div>
                  <div class="col-sm-3">
                    <p class="lead">Strip B</p>
                    <div class="form-check">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="enableStrip2"
                        name="enableStrip2"
                      />
                      <label class="form-check-label" for="enableStrip2"
                        >Enable</label
                      >
                    </div>

                    <div class="form-check">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="invertStrip2"
                        name="invertStrip2"
                      />
                      <label class="form-check-label" for="invertStrip2"
                        >Invert</label
                      >
                    </div>
                    <div>
                      <label for="indexStrip2" class="form-label"
                        >Display Index</label
                      >
                      <input
                        type="number"
                        min="0"
                        max="16"
                        class="form-control"
                        id="indexStrip2"
                        name="indexStrip2"
                      />
                    </div>
                    <div>
                      <label for="lengthStrip2" class="form-label"
                        >LED Count</label
                      >
                      <input
                        type="number"
                        min="0"
                        max="150"
                        class="form-control"
                        id="lengthStrip2"
                        name="lengthStrip2"
                      />
                    </div>
                  </div>
                  <div class="col-sm-3">
                    <p class="lead">Strip C</p>
                    <div class="form-check">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="enableStrip3"
                        name="enableStrip3"
                      />
                      <label class="form-check-label" for="enableStrip3"
                        >Enable</label
                      >
                    </div>

                    <div class="form-check">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="invertStrip3"
                        name="invertStrip3"
                      />
                      <label class="form-check-label" for="invertStrip3"
                        >Invert</label
                      >
                    </div>
                    <div>
                      <label for="indexStrip3" class="form-label"
                        >Display Index</label
                      >
                      <input
                        type="number"
                        min="0"
                        max="16"
                        class="form-control"
                        id="indexStrip3"
                        name="indexStrip3"
                      />
                    </div>
                    <div>
                      <label for="lengthStrip3" class="form-label"
                        >LED Count</label
                      >
                      <input
                        type="number"
                        min="0"
                        max="150"
                        class="form-control"
                        id="lengthStrip3"
                        name="lengthStrip3"
                      />
                    </div>
                  </div>
                  <div class="col-sm-3">
                    <p class="lead">Strip D</p>
                    <div class="form-check">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="enableStrip4"
                        name="enableStrip4"
                      />
                      <label class="form-check-label" for="enableStrip4"
                        >Enable</label
                      >
                    </div>

                    <div class="form-check">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="invertStrip4"
                        name="invertStrip4"
                      />
                      <label class="form-check-label" for="invertStrip4"
                        >Invert</label
                      >
                    </div>
                    <div>
                      <label for="indexStrip4" class="form-label"
                        >Display Index</label
                      >
                      <input
                        type="number"
                        min="0"
                        max="16"
                        class="form-control"
                        id="indexStrip4"
                        name="indexStrip4"
                      />
                    </div>
                    <div>
                      <label for="lengthStrip4" class="form-label"
                        >LED Count</label
                      >
                      <input
                        type="number"
                        min="0"
                        max="150"
                        class="form-control"
                        id="lengthStrip4"
                        name="lengthStrip4"
                      />
                    </div>
                  </div>
                  <hr class="my-4" />
                  <button
                    class="w-100 btn btn-primary btn-lg"
                    id="submitButton"
                    type="button"
                  >
                    Save Settings
                  </button>
                  <hr class="my-4" />

                  <div class="col-sm-3">
                    <label for="neighborsList" class="form-label"
                      >Neightbor Devices</label
                    >
                    <ul class="list-group" id="neighborsList"></ul>
                  </div>
                  <hr class="my-4" />

                  <button
                    class="w-100 btn btn-primary btn-lg"
                    id="resetNeighborsButton"
                    type="button"
                  >
                    Reset Neighbors
                  </button>
                  <hr class="my-4" />
                  <button
                    class="w-100 btn btn-primary btn-lg"
                    id="resetEspButton"
                    type="button"
                  >
                    Reset ESP32
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </main>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
      crossorigin="anonymous"
    ></script>

    <script>
      const urls = window.location.origin.includes(".local")
        ? {
            settings: "/settings",
            change: "/setSettings",
            reset: "/resetEsp",
            resetNeighbors: "/resetNeighbors",
          }
        : {
            settings: "http://livingroom1.local/settings",
            change: "http://livingroom1.local/setSettings",
            reset: "http://livingroom1.local/resetEsp",
            resetNeighbors: "http://livingroom1.local/resetNeighbors",
          };

      const tryParseInt = (val, errorMsg = "integer parse failed") => {
        const parsed = parseInt(val);
        if (isNaN(parsed)) {
          alert(errorMsg);
          throw Error(errorMsg);
        }
        return parsed;
      };
      let loaded = false;
      const stripIndexes = [1, 2, 3, 4];
      const controls = {
        mAnimationIndex: document.getElementsByName("mAnimationIndex").item(0),
        mBrightness: document.getElementsByName("mBrightness").item(0),
        mDeviceName: document.getElementsByName("mDeviceName").item(0),
        mTimezoneOffsetMinutes: document
          .getElementsByName("mTimezoneOffsetMinutes")
          .item(0),
        mUseDst: document.getElementsByName("mUseDst").item(0),
        strips: stripIndexes.map((i) => ({
          mEnable: document.getElementsByName(`enableStrip${i}`).item(0),
          mInvert: document.getElementsByName(`invertStrip${i}`).item(0),
          mLength: document.getElementsByName(`lengthStrip${i}`).item(0),
          mIndex: document.getElementsByName(`indexStrip${i}`).item(0),
        })),
        neighbors: document.getElementById("neighborsList"),
      };
      const updateControls = (settings) => {
        controls.mDeviceName.value = settings.mDeviceName;
        controls.mTimezoneOffsetMinutes.value = settings.mTimezoneOffsetMinutes;
        controls.mUseDst.checked = settings.mUseDst;
        controls.mBrightness.value = settings.mBrightness;
        controls.mAnimationIndex.value = settings.mAnimationIndex;
        stripIndexes.forEach((stripIndex, i) => {
          const control = controls.strips[i];
          const setting = settings.strips[i];
          control.mEnable.checked = setting.mEnable;
          control.mIndex.value = setting.mIndex;
          control.mLength.value = setting.mLength;
          control.mInvert.checked = setting.mInvert;
        });
        if (settings.neighbors.length) {
          controls.neighbors.innerHTML = settings.neighbors
            .map(
              (x) =>
                `<li class="list-group-item"><a href="http://${x}.local">${x}.local</a></li>`
            )
            .join("");
        } else {
          controls.neighbors.innerHTML = "No Neighbors detected.";
        }
      };

      const parseValues = () => {
        return {
          mDeviceName: controls.mDeviceName.value,
          mTimezoneOffsetMinutes: tryParseInt(
            controls.mTimezoneOffsetMinutes.value
          ),
          mUseDst: controls.mUseDst.checked,
          mBrightness: tryParseInt(controls.mBrightness.value),
          mAnimationIndex: tryParseInt(controls.mAnimationIndex.value),
          strips: controls.strips.map((strip) => ({
            mEnable: strip.mEnable.checked,
            mInvert: strip.mInvert.checked,
            mLength: tryParseInt(strip.mLength.value),
            mIndex: tryParseInt(strip.mIndex.value),
          })),
        };
      };

      const submitPayload = (payload) => {
        return new Promise((resolve, reject) => {
          const req = new XMLHttpRequest(); // new HttpRequest instance
          req.open("POST", urls.change);
          req.setRequestHeader(
            "Content-Type",
            "application/json;charset=UTF-8"
          );

          req.addEventListener("load", () => {
            if (req.status >= 200 && req.status < 300) {
              resolve(req.responseText);
            } else reject(Error("failed to submit"));
          });
          req.send(JSON.stringify(payload));
        });
      };

      const submitSomething = (endpoint) => {
        return new Promise((resolve, reject) => {
          const req = new XMLHttpRequest(); // new HttpRequest instance
          req.open("POST", endpoint);
          /*req.setRequestHeader(
            "Content-Type",
            "application/json;charset=UTF-8"
          );*/

          req.addEventListener("load", () => {
            console.log(req.status);
            if (req.status >= 200 && req.status < 300) {
              resolve();
            } else reject(Error("failed to submit to endpoint " + endpoint));
          });
          req.send();
        });
      };

      const registerHandlers = () => {
        document
          .getElementById("submitButton")
          .addEventListener("click", () => {
            console.log(`submit button`);
            const payload = parseValues();
            submitPayload(payload).then(() => {
              refresh();
            });
          });

        document
          .getElementById("resetNeighborsButton")
          .addEventListener("click", () => {
            console.log(`reset Neightbors button`);
            submitSomething(urls.resetNeighbors).then(() => {
              controls.neighbors.innerHTML = "Refreshing...";
              window.setTimeout(() => {
                refresh();
              }, 5000);
            });
          });

        document
          .getElementById("resetEspButton")
          .addEventListener("click", () => {
            console.log(`reset ESP button`);
            submitSomething(urls.reset).then(() => {
              controls.neighbors.innerHTML = "Rebooting...";
              window.setTimeout(() => {
                location.reload();
              }, 10000);
            });
          });

        controls.mBrightness.addEventListener("change", () => {
          const { mBrightness } = parseValues();
          const payload = { mBrightness };
          console.log(`brightness changed ${mBrightness}`);
          submitPayload(payload).then(() => {
            refresh();
          });
        });
        controls.mAnimationIndex.addEventListener("change", () => {
          const { mAnimationIndex } = parseValues();
          const payload = { mAnimationIndex };
          console.log(`nimation index changed ${mAnimationIndex}`);
          submitPayload(payload).then(() => {
            refresh();
          });
        });
      };
      const refresh = () => {
        const req = new XMLHttpRequest();
        req.onload = () => {
          // Process our return data
          if (req.status >= 200 && req.status < 300) {
            // Runs when the request is successful
            const settings = JSON.parse(req.responseText);
            console.log(JSON.parse(req.responseText));
            updateControls(settings);
            if (!loaded) {
              loaded = true;
              // data loaded the first time, let's attach event listeners.
              registerHandlers();
            }
          } else {
            // Runs when it's not
            console.log(req.responseText);
          }
        };
        req.open("GET", urls.settings);
        req.send();
      };
      console.log(controls);
      refresh();
    </script>
  </body>
</html>
